# 거래 및 뉴스 알림 에러 수정

## 문제점

1. **거래 알림 에러**: 서버 사이드에서 내부 API(`/api/analyze-trade`)를 `fetch`로 호출하여 발생하는 문제
   - 서버가 완전히 시작되지 않았을 때 연결 실패
   - 불필요한 네트워크 오버헤드
   - 에러 발생 시 거래 저장에 영향

2. **뉴스 알림 에러**: 비동기 알림 전송 중 에러가 발생해도 적절히 처리되지 않음
   - 알림 실패가 전체 플로우에 영향을 줄 수 있음
   - 에러 로깅이 불완전함

## 수정 내용

### 1. 거래 알림 개선 (`src/app/api/transactions/route.ts`)

- **내부 API 호출 제거**: `fetch('/api/analyze-trade')` 대신 직접 함수 호출로 변경
  - `createAIClient()` 및 `getOrSaveTransactionAnalysis()` 직접 호출
  - 서버 사이드에서 불필요한 HTTP 요청 제거
  - 에러 발생 시에도 거래 저장은 정상적으로 완료

- **에러 처리 강화**:
  - AI 분석 실패 시에도 거래 알림은 정상 전송
  - 텔레그램 전송 실패 시에도 로그 기록 및 거래 저장 유지
  - 최상위 에러 핸들링 추가로 예상치 못한 에러 처리

### 2. 뉴스 알림 개선 (`src/lib/cache.ts`)

- **에러 처리 강화**:
  - 알림 전송 실패가 뉴스 데이터 반환에 영향을 주지 않도록 처리
  - DB 업데이트 실패 시에도 로그 기록
  - 최상위 에러 핸들링 추가

- **로깅 개선**:
  - 모든 알림 시도와 실패를 로그에 기록
  - 에러 메시지 상세화

## 변경된 파일

- `src/app/api/transactions/route.ts`: 거래 알림 로직 개선
- `src/lib/cache.ts`: 뉴스 알림 에러 처리 개선

## 테스트 방법

1. **거래 추가 테스트**:
   ```bash
   # 브라우저에서 거래 추가 후 서버 로그 확인
   # 알림 실패 시에도 거래가 정상적으로 저장되는지 확인
   ```

2. **뉴스 알림 테스트**:
   ```bash
   # 뉴스 API 호출 후 서버 로그 확인
   # 알림 실패 시에도 뉴스 데이터가 정상적으로 반환되는지 확인
   ```

3. **에러 시나리오 테스트**:
   - 텔레그램 토큰/채팅 ID 미설정 시
   - Ollama 미실행 시
   - 네트워크 오류 시

## 주의사항

- 텔레그램 알림이 실패해도 거래/뉴스 데이터는 정상적으로 저장/반환됩니다
- 알림 실패는 `notification_log` 테이블에 기록되며, 자동 재시도 로직이 작동합니다
- 환경 변수(`TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`)가 설정되지 않으면 알림은 건너뜁니다

## 관련 문서

- `docs/notification-troubleshooting.md`: 알림 문제 해결 가이드
- `docs/api/transactions.md`: 거래 API 문서
- `docs/api/news.md`: 뉴스 API 문서

